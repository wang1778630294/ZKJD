function initFMNavigation(t){navi=new fengmap.FMNavigation({map:t,lineStyle:{lineType:fengmap.FMLineType.FMARROW,lineWidth:3},showLocMarker:!1}),handleNaviEvent()}function showMyLocation(){locationMarker||(locationMarker=new fengmap.FMLocationMarker({url:"../images/pointer.png",size:46,height:1}),map.addLocationMarker(locationMarker)),locationMarker.visible=!0,updateLocMarkerPos(globalData.cur_Point)}function hideMyLocMarker(){locationMarker&&(locationMarker.visible=!1)}function updateLocMarkerPos(t){locationMarker.setPosition({x:t.x,y:t.y,groupID:t.groupID,zOffset:1})}function updateLocMarkerDirect(t){locationMarker&&(locationMarker.direction=t)}function addRouteLine(t,a,e,o,n,i){removeAllMarkers(),clearAllRoutes(),t.x==o.x&&t.y==o.y&&a==n||(navi.setStartPoint({x:t.x,y:t.y,height:0,groupID:a,url:"../images/start.png",size:32}),navi.setEndPoint({x:o.x,y:o.y,height:0,groupID:n,url:"../images/end.png",size:32}),navi.drawNaviLine(),showStartAndEndIcon(a,n))}function isSameStartAndEnd(t,a){return t.x==a.x&&t.y==a.y&&t.groupID==a.groupID}function showRouteTip(t,a){var e=-1;return isSameStartAndEnd(t,a)&&(commonAlert(errorMsg.START_END_SAME),e=0),getRouteDistance()<=0&&(commonAlert(errorMsg.NO_ROUTE),e=1),e>=0&&navi.clearNaviLines(),e}function getRemainTime(t){return Math.ceil(t/globalData.walkingSpeed)}function getRouteDistance(){return Math.ceil(navi.naviDistance)}function getNaviDescription(t){return navi.naviDescriptions[t]}function updateNaviDataInfo(t){var a=globalData.cur_direction;NaN!=t.angle&&(globalData.routeDirection=t.angle),$(".navi-info .navi-angle").text("地图角度："+t.angle);var e=getGroupNameByGid(t.point.groupID).toUpperCase(),o=Math.ceil(t.distanceToNext)||0,n=getNaviDescription(t.index);if(0==o){n=n.trim();var i=n.split(" ");i.length>0&&(n=i[i.length-1])}else n=n.replace(/\d+/,o);n=n.replace(/undefined/g,"");var r=Math.ceil(t.remain);(t.remain<globalData.finishDistance&&(r=0,n=errorMsg.FINISH_NAVI,routeIndex=-1,isArrived=!0),updateNaviInfo(e,getRemainTime(r),n,r),updateLocMarkerPos(t.point,a),moveToCenter(t.point),routeIndex!=t.index||-1==routeIndex)&&(getVoiceStatus()?startNaviVoice(n):resetAudio(),routeIndex=-1==routeIndex?-2:t.index);if(0==r)return hideNaviPage(),void switchVoiceIcon(!1)}function updateNavi(t){if(isNaving){var a=navi.naviConstraint(t),e=a.distance,o="x:"+t.x+"y:"+t.y+"<br/>groupID:"+t.groupID+"dis:"+e;if($(".navi-info .navi-dis").empty().append(o),(null==e||e>=globalData.constraintDis)&&!globalData.isRecalcRoute){globalData.isRecalcRoute=!0;var n=(new Date).getTime()-globalData.NaviConstraintTime;if(!hasPopWin()&&n>globalData.noOpTime){startNaviVoice(errorMsg.AWAY_NAVI),globalData.NaviConstraintTime=(new Date).getTime(),setTimeout(function(){showResetNavi()},1500)}else resetAudio()}else resetMyLocWithConstraint(t,a)}}function resetMyLocWithConstraint(t,a){var e=globalData.cur_direction;navi.locateNoConstraint(t,a,e)}function play(t,a){resetAudio(),ssb_param={appid:"58806486",appkey:"62c83fd033617a02",synid:"12345",params:"ent=aisound,aue=lame,vcn="+a},session.start(ssb_param,t,function(t,a){if(null!=a.audio_url&&void 0!=a.audio_url){start(audioPalyUrl+a.audio_url)}})}function resetAudio(){null!=window.iaudio?(stop(),window.iaudio.src=""):(window.iaudio=new Audio,window.iaudio.src="")}function start(t){if(window.iaudio&&window.iaudio.src&&""!=window.iaudio.src&&(0==window.iaudio.readyState||window.iaudio.ended))try{stop(),window.iaudio.currentTime=0,window.iaudio.src=t,window.iaudio.play().catch(function(t){})}catch(t){}}function stop(){window.iaudio&&window.iaudio.src&&""!=window.iaudio.src&&window.iaudio.pause()}function startNaviVoice(t){var a=t.replace(/\s/g,"");a=a.replace(/undefined/g,""),play(a,"aisxping")}function stopNavi(){routeIndex=0,resetAudio()}function handleNaviEvent(){navi.on("walking",function(t){updateNaviDataInfo(t)})}function inDoorLocationListener(){setTimeout(function(){globalData.isInDoorLocated&&(new Date).getTime()>last_ble_response_date+5e3&&(globalData.isInDoorLocated=!1,globalData.last_located_floor_name=void 0,globalData.cur_Point=null,setLocIconToGray(),globalData.isFirstLoction=0,hideMyLocMarker())},5e3)}function startOutDoorLocation(){location_type=0,globalData.isFirstLoction=0,control.stopLocate(),control==window||control.onUpdateLocation(),control.startLocate(location_type,1e3,jsonStr,!0,!0,!0),control==window&&control.onUpdateLocation()}function startInDoorLocation(){location_type=1,globalData.isFirstLoction=0,control.stopLocate(),control.startLocate(location_type,1e3,jsonStr,!0,!0,!0),control.onUpdateLocation()}function resetInDoorLocation(){location_type=1,globalData.isFirstLoction=0,control.startLocate(location_type,1e3,jsonStr,!0,!0,!0),control.onUpdateLocation()}function setCurrentLocation(){void 0!==globalData.gpsLoaction_lon&&void 0!==globalData.gpsLocation_lat&&outDoorMapUtil.zoomOutDoorMap(globalData.gpsLoaction_lon,globalData.gpsLocation_lat)}function initControlInfo(){control.isJudgeIndoorOutdoor(!0,-98,3),control.startLocate(location_type,1e3,jsonStr,!0,!0,!0),control.onUpdateLocation(),control.getLocalMaps()}function createFMap(){function t(){setTimeout(function(){initControlInfo()},2400),$(".map-loading").hide(),initFMNavigation(map);var t=new fengmap.controlOptions({position:fengmap.controlPositon.LEFT_BOTTOM,showBtnCount:3,allLayer:!1,needAllLayerBtn:!1,offset:{x:0,y:100}});groupControl=new fengmap.scrollGroupsControl(map,t),groupControl.onChange(function(t,a){});var a=map.mapService.staticScene_.scene.date_ver;$(".navi-info .navi-info-lanya").text("数据版本号："+a.high+"."+a.low)}map=new fengmap.FMMap({container:document.getElementById("fengMap"),mapServerURL:"../data/"+globalData.fmapID,defaultViewMode:fengmap.FMViewMode.MODE_2D,mapThemeURL:"../data/theme",defaultThemeName:"3010",compassOffset:[10,140],compassSize:48,defaultMapScaleLevel:globalData.initLevel,key:"6d38c18fe69bf1c38b0dfd71c92caf44",appName:"蓝牙工具",useStoreApply:!0,groupLoadedCallback:function(t){}}),map.showCompass=!0,map.openMapById(globalData.fmapID,function(t){}),map.on("loadComplete",function(){map.pickExclude={nodeType:[11,12],typeID:[300001]},map.visibleGroupIDs=[globalData.mainGroupID],map.focusGroupID=globalData.mainGroupID,map.getGroupData(3),t()}),map.on("mapClickCompass",function(){isNaving||updateMapRoate(globalData.originMapRotate)}),map.on("groupLoaded",function(t){loadedGroups.push(t)}),map.on("mapClickNode",function(t){if(t.nodeType==fengmap.FMNodeType.FACILITY||t.nodeType==fengmap.FMNodeType.LABEL||t.nodeType==fengmap.FMNodeType.IMAGE_MARKER)return void(isPoiClick=!0);if(isPoiClick=!1,!isNaving){switch(clickType){case 0:if(t.nodeType==fengmap.FMNodeType.MODEL){var a=getClickData(t);removeAllMarkers(),clickMarker=addClickMarker(t.groupID,t.mapCoord),showClickModelInfo(a)}break;case 1:if(t.nodeType==fengmap.FMNodeType.NONE)break;if(!t.groupID)break;var e=t.eventInfo.coord,o=t;o.mapCoord=e,setStartOrEndPoint(o.groupID,o)}0!=clickType||t.nodeType!=fengmap.FMNodeType.FLOOR&&t.nodeType!=fengmap.FMNodeType.NONE||(removeClickMarker(),hideClickModelInfo())}})}function getNoLoadedGroupGID(){var t=[];return map.listGroups.forEach(function(a){loadedGroups.indexOf(a.gid)<0&&t.push(a.gid)}),t}function addClickMarker(t,a,e){var o=map.getFMGroup(t),n=o.getOrCreateLayer("imageMarker"),i=new fengmap.FMImageMarker({x:a.x,y:a.y,url:"../images/loc.png",size:32,height:0,callback:function(){i.alwaysShow(),e&&e()}});return n.addMarker(i),i}function removeClickMarker(){clickMarker&&clickMarker.dispose(),clickMarker=null}function removeSearchedMarkers(){searchMarkers.forEach(function(t,a){t.dispose()}),searchMarkers=[]}function removeAllMarkers(){removeClickMarker(),hideClickModelInfo(),removeSearchedMarkers()}function findTypeId(t){var a={nodeType:fengmap.FMNodeType.MODEL,typeID:t};map.search("all",a,function(t){var a=t;null!=a&&a.length>0?addSearchedMarkers(a):(removeAllMarkers(),commonAlert("未找到结果！"))})}function addMarkers(t,a){(a=a||0)<t.length&&setTimeout(function(){var e=t[a],o=addClickMarker(e.groupID,e.mapCoord,function(){a++,addMarkers(t,a),searchMarkers.push(o)})},0)}function addSearchedMarkers(t){removeAllMarkers();var a=null,e={};if(addMarkers(t.map(function(t){return e[t.groupID]||(e[t.groupID]=t.groupID),{groupID:t.groupID,mapCoord:t.mapCoord}})),a=getResGroupType(parseInt(map.focusGroupID),e)){switch(a.type){case 2:case 4:switchFloor(a.focusid)}switchMapScaleLevel(globalData.allMapLevel)}}function getResGroupType(t,a){var e=[],o=!1;for(var n in a)n==t&&(o=!0),e.push(parseInt(n));return 1==e.length&&o?{type:1,focusid:t}:1!=e.length||o?e.length>1&&o?{type:3,focusid:t}:e.length>1&&!o?{type:4,focusid:e[0]}:null:{type:2,focusid:e[0]}}function searchModelByKeyword(t){var a={nodeType:fengmap.FMNodeType.MODEL,keyword:t.trim()},e=[];return map.search("all",a,function(t){e=t}),e}function getGroupNameByGid(t){return map.getFMGroup(t).groupName}function searchModelByFID(t,a){var e=null,o={nodeType:fengmap.FMNodeType.MODEL,FID:t};return map.search(a,o,function(t){var a=t;a.length>=1&&(e=a[0])}),e}function clickModel(t,a){if(a){var e=getClickData(a);removeAllMarkers(),clickMarker=addClickMarker(t,e),showClickModelInfo(e),moveToCenter(e)}}function getClickData(t){var a={x:t.mapCoord.x,y:t.mapCoord.y,groupID:t.groupID,name:t.name,groupName:getGroupNameByGid(t.groupID).toUpperCase(),type:t.typeID};return a.name=a.name&&""!=a.name?a.name:"地图选点",a}function moveToCenter(t){if(isNaving){if(!globalData.isTouched){var a=(new Date).getTime(),e=a-globalData.preTouchedTime;(0==globalData.preTouchedTime||e>globalData.noOpTime)&&(t.groupID!=map.focusGroupID&&switchFloor(t.groupID),map.moveTo(t),switchMapScaleLevel(globalData.naviLevel),updateMapRoate(globalData.routeDirection),globalData.preTouchedTime=(new Date).getTime())}}else t.groupID!=map.foucusGroupID&&switchFloor(t.groupID),map.moveTo(t),updateMapRoate(globalData.originMapRotate)}function switchMapScaleLevel(t){map.mapScaleLevel=t}function clearAll(){removeAllMarkers(),clearAllRoutes(),stopNavi(),clickType=0,isNaving=!1,map.selectNull()}function updateMapRoate(t){NaN!=t&&void 0!=t&&map.rotateTo({to:t,duration:.3,callback:function(){}})}function getMapRotateAngle(){return map.rotateAngle}function clearAllRoutes(){navi.clearAll(),clearFloorIcons()}function switchFloor(t){map.visibleGroupIDs=[t],map.focusGroupID=t}function switchMapMode(t){map.viewMode=0==t?fengmap.FMViewMode.MODE_2D:fengmap.FMViewMode.MODE_3D}function getMapScaleLevel(){return map.mapScaleLevel}function getTwoPntDistance(t,a){return t.groupID!=a.groupID?1/0:DistanceofTwoPts(t,a)}function updateDataXYByModelLabel(t,a){var e=map.getModelLabelObject(t);return e&&(a.x=e.fm_.mapCoord.x,a.y=e.fm_.mapCoord.y),a}function resolveScroll(){var t,a=$(".category-pop");a.on("touchstart",function(a){t=a.touches[0].clientY}),a.on("touchmove",function(a){var e="11",o=this,n=a.touches[0].clientY;if(0===o.scrollTop?e=o.offsetHeight>=o.scrollHeight?"00":"01":o.scrollTop+o.offsetHeight>=o.scrollHeight&&(e="10"),"11"!=e){var i=n-t>0?"10":"01";parseInt(e,2)&parseInt(i,2)||stopEvent(a)}})}function switchVoiceIcon(t){t?($("#clearAllStatus").hide(),$("#voiceStatus").show(),showNaviGroupShade()):($("#clearAllStatus").show(),$("#voiceStatus").hide(),hideNaviGroupShade())}function getPoiType(){$.getJSON("../data/poitype.json",function(t){var a=t.poiTypes;globalData.poiTypes=a;var e=$(".shortcut-wrap ul"),o="",n=$(".category-cont ul"),i="";$.each(a,function(t,a){1==a.level?i+='<li onClick="getCategoryMapData(this);" data-id="'+a.type+'"><i class="icon iconfont '+a.icon+'"></i><span class="categoryTitle">'+a.name+"</span></li>":o+='<li onClick="getCategoryMapData(this);" data-id="'+a.type+'"><span class="iconStyle"><i class="icon iconfont '+a.icon+'"></i></span><span class="categoryTitle">'+a.name+"</span></li>"}),e.html(o),n.html(i)})}function showStartAndEndIcon(t,a){var e=$(".fm-layer-list label[data-gid="+t+"]"),o=$(".fm-layer-list label[data-gid="+a+"]"),n=$("#fengMap").height();if(t==a){var i=e.offset().top;$("#sameIcon").empty().append("<img src='images/sametip.png' />"),$("#sameIcon").css("bottom",n-i-48)}else{var i=e.offset().top,r=o.offset().top;$("#startIcon").empty().append("<img src='images/stip.png' />"),$("#endIcon").empty().append("<img src='images/etip.png' />"),$("#startIcon").css("bottom",n-i-40),$("#endIcon").css("bottom",n-r-40)}}function getCategoryMapData(t){var a=$(t).attr("data-id"),e=$(t).children(".categoryTitle").text();$("#searchTxt").val(e),findTypeId(a),hideCategoryPop()}function showCategoryPop(t){$(".category-pop").show(),$(".clearBtn").show(),$("#backBtn>i").removeClass("icon-search").addClass("icon-fanhui"),hideSearchList(),0==pageindex&&($(".category-cont.types").show(),$(".category-cont.btns,.category-cont.blank").hide()),1==pageindex&&($(".category-cont.types").hide(),$(".category-cont.btns,.category-cont.blank").show())}function hideCategoryPop(){$(".category-pop").hide(),pageindex=0}function showClickModelInfo(t){setInputDataAttr(".info-wrap .text-area .modelname",t),$(".info-wrap .text-area .modelname").text(t.name),$(".info-wrap .text-area .groupname").text(t.groupName+"层");var a="无";$.each(globalData.poiTypes,function(e,o){if(t.type==o.type)return a=o.name,!0}),$(".info-wrap .text-area .typename").text(a),$(".info-wrap").css("display","block")}function hideClickModelInfo(){$(".info-wrap").css("display","none")}function showSearchList(t){$("#hotwords").css("display","block"),$("#hotwords").empty();var a="";for(var e in t){var o=t[e],n=getGroupNameByGid(o.groupID).toUpperCase();o.name&&""!=o.name&&(a+='<li data-gid="'+o.groupID+'" data-name="'+o.name+'" data-fid="'+o.FID+'"><i class="icon iconfont icon-sousuodingwei"></i>'+o.name+"<span>"+n+"</span></li>")}""!=a&&($("#hotwords").append(a),$("#hotwords li").click(function(){var t=($("#hotwords ul li").index($(this)),$(this).data("fid")),a=$(this).data("gid"),e=searchModelByFID(t,a);if(0==pageindex&&($("#searchTxt").val($(this).data("name")),clickModel(a,e),hideSearchList(),hideCategoryPop()),1==pageindex){$("#searchTxt").val(""),setMapClickLoc();setStartOrEndPoint(a,e)}}))}function hideSearchList(){$("#hotwords").css("display","none")}function showRoute(){var t="";globalData.cur_Point&&(t="我的位置",isStartInput=2);var a=$(".info-wrap .text-area .modelname").text(),e=getPointByName(".info-wrap .text-area .modelname");if($("#route-panel input[name='startTxt']").val(t),setInputDataAttr("#route-panel input[name='startTxt']",globalData.cur_Point),$("#route-panel input[name='endTxt']").val(a),setInputDataAttr("#route-panel input[name='endTxt']",e),$("#route-panel").show(),globalData.cur_Point){var o=isMyLocation(a);addRouteLine(globalData.cur_Point,globalData.cur_Point.groupID,!0,e,e.groupID,o),showRouteTip(globalData.cur_Point,e)}else commonAlert(errorMsg.NO_LOCATION)}function hideRoute(){clickType=0,$("#route-panel").css("display","none")}function getPointByName(t){return{x:$(t).data("x"),y:$(t).data("y"),groupID:$(t).data("gid")}}function setInputDataAttr(t,a){a&&($(t).data("x",a.x),$(t).data("y",a.y),$(t).data("gid",a.groupID))}function isMyLocation(t){return"我的位置"==t}function showPickPage(t){pageindex=1,hideSearchList(),isStartInput=t,$("#searchTxt").val(""),$("#searchTxt").focus()}function isHasMyLocation(){var t=$("#route-panel input[name='endTxt']").val();return isMyLocation($("#route-panel input[name='startTxt']").val())?1:isMyLocation(t)?2:0}function setStartOrEndPoint(t,a){if(a){var e=getClickData(a);isHasMyLocation()==isStartInput?1==isStartInput?($("#route-panel input[name='endTxt']").val(e.name),setInputDataAttr("#route-panel input[name='endTxt']",e)):($("#route-panel input[name='startTxt']").val(e.name),setInputDataAttr("#route-panel input[name='startTxt']",e)):2==isStartInput?($("#route-panel input[name='endTxt']").val(e.name),setInputDataAttr("#route-panel input[name='endTxt']",e)):($("#route-panel input[name='startTxt']").val(e.name),setInputDataAttr("#route-panel input[name='startTxt']",e));var o=($("#route-panel input[name='startTxt']").val(),getPointByName("#route-panel input[name='startTxt']")),n=($("#route-panel input[name='endTxt']").val(),getPointByName("#route-panel input[name='endTxt']"));if(!(o.x&&n.x||globalData.cur_Point))return void commonAlert(errorMsg.NO_LOCATION);isSameStartAndEnd(o,n)?showRouteTip(o,n):(addRouteLine(o,o.groupID,!0,n,n.groupID,!0),showRouteTip(o,n),hideSearchList(),hideCategoryPop())}}function setMyLoc(){1==isStartInput?($("#route-panel input[name='startTxt']").val("我的位置"),setInputDataAttr("#route-panel input[name='startTxt']",globalData.cur_Point),isStartInput=2):2==isStartInput&&($("#route-panel input[name='endTxt']").val("我的位置"),setInputDataAttr("#route-panel input[name='endTxt']",globalData.cur_Point),isStartInput=1),hideCategoryPop();var t=$("#route-panel input[name='startTxt']").val(),a=getPointByName("#route-panel input[name='startTxt']"),e=$("#route-panel input[name='endTxt']").val(),o=getPointByName("#route-panel input[name='endTxt']"),n=isMyLocation(t),i=isMyLocation(e);addRouteLine(a,a.groupID,n,o,o.groupID,i)}function setMapClickLoc(){1==isStartInput?$("#route-panel input[name='startTxt']").val("地图选点"):2==isStartInput&&$("#route-panel input[name='endTxt']").val("地图选点"),hideCategoryPop()}function hideHomePage(){$(".shortcut-wrap").hide(),hideRoute()}function showHomePage(){$(".shortcut-wrap").show(),$("#route-panel").show()}function showNaviPage(){isNaving=!0,clickType=2,hideHomePage(),isArrived=!1,$(".navi-bottom-tip").show(),$(".navi-header").show();var t=$("#route-panel input[name='endTxt']").val(),a=getPointByName("#route-panel input[name='endTxt']"),e=getGroupNameByGid(a.groupID).toUpperCase(),o=getRouteDistance(),n=getRemainTime(o);$(".navi-bottom-tip .mname").text(t);var i=getNaviDescription(0);updateNaviInfo(e,n,i,o),startNaviVoice(errorMsg.START_NAVI),setTimeout(function(){startNaviVoice(i)},3e3)}function setMyLocToStartPnt(){isStartInput=1,setMyLoc()}function updateNaviInfo(t,a,e,o){$(".navi-bottom-tip .gname").text(t),$(".navi-bottom-tip .remain").text(a),$(".navi-header .navi-directiion").text(e),$(".navi-header .navi-distance").text(o)}function hideNaviPage(){isNaving=!1,clickType=1,$(".navi-bottom-tip").hide(),$(".navi-header").hide(),showHomePage(),switchMapScaleLevel(globalData.currentLevel),$("#clearAllStatus").trigger("click"),updateMapRoate(globalData.currentMapRotate),resetAudio()}function showOutDoorMap(){$("#outdoorBtn").click(function(){_showJumpConfirm(0,!0)}),$("#inDoor-btn").click(function(){_showJumpConfirm(1,!0)}),$("#gpsLocation-btn").click(function(){var t=$(this).children();t.hasClass("gpsLocation-active")||t.addClass("gpsLocation-active"),setCurrentLocation()})}function clearFloorIcons(){$(".floorIcon").empty()}function _showJumpConfirm(t,a){if((!t||"none"!=$("#outDoorMapContainer").css("display"))&&(t||"none"==$("#outDoorMapContainer").css("display"))){if(!hasPopWin()){var e={};if(e.title="",e.body_html=t?"您已到达室内，是否切换地图？":"您已到达室外，是否切换地图？",e.confirmText="确认",e.cancelText="取消",a)switchOutOrIn(t);else{layer.open({title:!1,type:1,content:e.body_html+"<div class='noAlert'><input type='checkbox' id='noAlertChk' value='不再提醒' onclick='noAlertFunc()'></input><label>不再提醒</label></div>",btn:[e.confirmText,e.cancelText],closeBtn:0,yes:function(a,e){switchOutOrIn(t),layer.close(a)},btn2:function(t,a){layer.close(t)}})}}}}function hasPopWin(){return!(!$(".layui-layer-shade").css("display")||"none"==$(".layui-layer-shade").css("display"))||"none"!=$(".layui-layer.layui-layer-dialog").css("display")&&2==$(".layui-layer.layui-layer-dialog").find(".layui-layer-btn").children().length}function noAlertFunc(){var t=$("#noAlertChk").prop("checked");globalData.noAlertInOutTip=t}function switchOutOrIn(t){if(t)$("#outDoorMapContainer").hide(),startInDoorLocation();else{if(globalData.appArr.length>0){var a="";$("#mapApps ul").empty(),globalData.appArr.forEach(function(t){a+="<li>"+t+"</li>"}),a+='<li class="cancelLi">取消</li>',$("#mapApps ul").prepend(a),$("#mapApps").show(),$("#mapApps ul li").not(":last").on("click",function(){var t=$("#mapApps ul li").index($(this)),a=globalData.appArr[t];doJumpApp(a),$(this).parents("#mapApps").hide()}),$("#mapApps ul li:last").on("click",function(){$(this).parents("#mapApps").hide()})}else $("#outDoorMapContainer").show(),$("#outDoorMapContainer").height(document.documentElement.clientHeight),outDoorMapUtil.zoomOutDoorMap(globalData.out_door_lon,globalData.out_door_lat),startOutDoorLocation();isNaving&&(hideNaviPage(),switchVoiceIcon(!1))}}function setLocIconToGray(){var t=$("#locationBtn").children(".position-icon");t.hasClass("position-active")&&t.removeClass("position-active")}function setLocIconToBlue(){var t=$("#locationBtn").children(".position-icon");t.hasClass("position-active")||t.addClass("position-active")}function showConfirmStopNavi(){stop(),layer.open({type:1,title:!1,content:errorMsg.LEAVE_NAVI,btn:["是","否"],closeBtn:0,yes:function(t,a){switchVoiceIcon(!1),hideNaviPage(),layer.close(t)},btn2:function(t,a){start(),layer.close(t)}})}function showResetNavi(){layer.open({type:1,title:!1,content:errorMsg.AWAY_NAVI,btn:["是","否"],closeBtn:0,yes:function(t,a){layer.close(t),$("#startNavi").trigger("click")},btn2:function(t,a){globalData.isRecalcRoute=!0,layer.close(t)}})}function confirmFloorChange(t){layer.open({type:1,title:!1,content:errorMsg.CHANGE_FLOOR,btn:["是","否"],closeBtn:0,yes:function(a,e){switchFloor(t),layer.close(a)},btn2:function(t,a){layer.close(t)}})}function updateMyLocInfo(){if(1==pageindex){var t=$("#route-panel input[name='startTxt']").val(),a=$("#route-panel input[name='endTxt']").val(),e=isMyLocation(t),o=isMyLocation(a),n=getPointByName("#route-panel input[name='startTxt']"),i=getPointByName("#route-panel input[name='endTxt']");if(e){var r=getTwoPntDistance(n,globalData.cur_Point);r>=globalData.minReRouteDis&&(setInputDataAttr("#route-panel input[name='startTxt']",globalData.cur_Point),addRouteLine(globalData.cur_Point,globalData.cur_Point.groupID,e,i,i.groupID,o))}if(o){var r=getTwoPntDistance(i,globalData.cur_Point);r>=globalData.minReRouteDis&&(setInputDataAttr("#route-panel input[name='endTxt']",globalData.cur_Point),addRouteLine(n,n.groupID,e,globalData.cur_Point,globalData.cur_Point.groupID,o))}}}function getVoiceStatus(){return!$("#voiceStatus").children().hasClass("voice-active")}function commonAlert(t){layer.msg(t,{time:1e3},function(){layer.closeAll("dialog")})}function showNaviGroupShade(){var t=$("#fengMap").height(),a=$(".fm-control-groups").height(),e=$(".fm-control-groups").offset().top;$("#groupLayer_Shade").height(a),$("#groupLayer_Shade").css("bottom",t-a-e+"px"),$("#groupLayer_Shade").css("z-index",1e3),$("#groupLayer_Shade").show()}function hideNaviGroupShade(){$("#groupLayer_Shade").css("z-index",0),$("#groupLayer_Shade").hide()}!function(t){var a=0;!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)?window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(e){e.webkitCompassHeading&&(a=360-e.webkitCompassHeading),t.orientationCallback&&t.orientationCallback(a)},!1):window.DeviceOrientationEvent&&window.addEventListener("deviceorientationabsolute",function(e){a=e.webkitCompassHeading?e.webkitCompassHeading:e.alpha,t.orientationCallback&&t.orientationCallback(a)})}(this.fengmap=this.fengmap||{});var globalData={fmapID:"jd-xz-10001",mainGroupID:2,curfloornum:0,out_door_lon:116.31896148337734,out_door_lat:39.98038623378987,counttest:0,routePlanJson:[],startPoint:null,endPoint:null,isFirstLoction:0,isInDoorLocated:!1,noAlertInOutTip:!1,navigateEnable:!1,cur_x:0,cur_y:0,cur_Point:null,pre_Point:null,poiTypes:[],cur_direction:0,last_located_floor_id:1,gpsLoaction_lon:void 0,gpsLocation_lat:void 0,appArr:[],preTouchedTime:0,NaviConstraintTime:0,noOpTime:5e3,finishDistance:8,minReRouteDis:10,constraintDis:10,walkingSpeed:80,initLevel:18,allMapLevel:16,naviLevel:21,currentLevel:18,originMapRotate:345,currentMapRotate:0,preMapRotate:0,routeDirection:0,isTouched:!1,isRecalcRoute:!1},groupType={B2:1,B1:2,F1:3},errorMsg={NO_LOCATION:"未找到我的位置",START_NAVI:"开始导航",FINISH_NAVI:"到达终点",AWAY_NAVI:"已偏离路线，是否重新规划？",LEAVE_NAVI:"是否确定退出导航？",CHANGE_FLOOR:"搜索结果在不同楼层，是否切换楼层？",START_END_SAME:"相同的起点和终点",TOO_CLOSE:"距离目标位置太近，请重新选择终点",NO_ROUTE:"不可访问区域"},fmEvents={create:function(){var t=function(t){isNaving?(globalData.preTouchedTime=(new Date).getTime(),globalData.isTouched=!0):globalData.isTouched=!1},a=function(t){globalData.isTouched=!isNaving,globalData.preTouchedTime=(new Date).getTime()},e=function(t){isNaving?(globalData.preTouchedTime=(new Date).getTime(),globalData.isTouched=!0):globalData.isTouched=!1};return{bindMapClickEvent:function(){document.getElementById("fengMap").addEventListener("mousedown",t),document.getElementById("fengMap").addEventListener("mousemove",e),document.getElementById("fengMap").addEventListener("mouseup",a),document.getElementById("fengMap").addEventListener("touchstart",t),document.getElementById("fengMap").addEventListener("touchmove",e),document.getElementById("fengMap").addEventListener("touchend",a)}}}},outDoorMapUtil_={create:function(t){var a,e,o=function(t,a){var e=new AMap.Map("outDoorMapContainer",{resizeEnable:!0,zoom:14,center:c(t,a)});new AMap.Icon({image:"../images/mark_r.png"});return e},n=function(t,e){a=void 0!==a?a:o(t,e),a.panTo(c(t,e)),a.setZoom(14)},i=function(t,o){void 0!==a&&(void 0===e?e=new AMap.Marker({position:c(t,o),map:a}):e.setPosition(c(t,o)))},r=Math.PI,l=(Math.PI,.006693421622965943),c=function(t,a){var a=+a,t=+t;if(p(t,a))return[t,a];var e=s(t-105,a-35),o=u(t-105,a-35),n=a/180*r,i=Math.sin(n);i=1-l*i*i;var c=Math.sqrt(i);return e=180*e/(6335552.717000426/(i*c)*r),o=180*o/(6378245/c*Math.cos(n)*r),[t+o,a+e]},s=function(t,a){var a=+a,t=+t,e=2*t-100+3*a+.2*a*a+.1*t*a+.2*Math.sqrt(Math.abs(t));return e+=2*(20*Math.sin(6*t*r)+20*Math.sin(2*t*r))/3,e+=2*(20*Math.sin(a*r)+40*Math.sin(a/3*r))/3,e+=2*(160*Math.sin(a/12*r)+320*Math.sin(a*r/30))/3},u=function(t,a){var a=+a,t=+t,e=300+t+2*a+.1*t*t+.1*t*a+.1*Math.sqrt(Math.abs(t));return e+=2*(20*Math.sin(6*t*r)+20*Math.sin(2*t*r))/3,e+=2*(20*Math.sin(t*r)+40*Math.sin(t/3*r))/3,e+=2*(150*Math.sin(t/12*r)+300*Math.sin(t/30*r))/3},p=function(t,a){var a=+a,t=+t;return!(t>73.66&&t<135.05&&a>3.86&&a<53.55)};return{zoomOutDoorMap:n,markerOutDoorLocate:i}}},locationMarker=null,navi=null,isNaving=!1,routeIndex=0,isArrived=!1,audioPalyUrl="http://h5.xf-yun.com/audioStream/",session=new IFlyTtsSession({url:"ws://h5.xf-yun.com/tts.do",reconnection:!0,reconnectionDelay:3e4});window.iaudio=null,fengmap.orientationCallback=function(t){globalData.cur_direction=t,updateLocMarkerDirect(t)};var control=void 0===control?window:control,location_type=1,jsonStr='{"uuid":"fda50693-a4e2-4fb1-afcf-c6eb07647825","major":"2774","buildingCode":"B_0000_1610733D20D","version":2,"url":"http://location.powerlbs.com/lbs/ble/B_0000_1610733D20D/modelbt.par"}',outDoorMapUtil=new outDoorMapUtil_.create({}),last_ble_response_date,testTime=0;window.sendSystemInfo=function(t){layer.msg(t,{time:1e3})},window.sendBleLocateInitState=function(t){var a=JSON.parse(t);$(".navi-info .navi-info-lanya").text("蓝牙状态："+a.status),"-2"==a.status&&layer.msg("请在手机设置中开启蓝牙",{time:1e3}),"-6"==a.status&&layer.msg("定位位置服务未开启",{time:1e3}),"-7"==a.status&&layer.msg("gps 不可用",{time:1e3})},window.sendBleLocateRes=function(t){1e3==++globalData.counttest&&(globalData.counttest=0);var a=JSON.parse(t);if($(".navi-info .navi-info-status").text("定位状态："+a.status+",isIndoor:"+a.type+",inOut:"+a.InOut+",次数"+globalData.counttest),$(".navi-info .navi-info-floor").text(a.floor),$(".navi-info .navi-info-loc").text(a.x+","+a.y),globalData.isInDoorLocated=!1,100==a.status){if("undefined"==a.InOut)return;return void(globalData.noAlertInOutTip||_showJumpConfirm(parseInt(a.InOut),!1))}if(1==a.status&&"undefined"!=a.type)if(1==a.type){globalData.isInDoorLocated=!0,last_ble_response_date=(new Date).getTime(),inDoorLocationListener();var e=groupType[a.floor];globalData.cur_Point={x:parseFloat(a.x),y:parseFloat(a.y),groupID:e},isNaving?updateNavi(globalData.cur_Point):(showMyLocation(),0==globalData.isFirstLoction?(setLocIconToBlue(),moveToCenter(globalData.cur_Point),globalData.last_located_floor_id=e):(e!=globalData.last_located_floor_id&&(moveToCenter(globalData.cur_Point),globalData.last_located_floor_id=e),updateMyLocInfo()),globalData.isFirstLoction++)}else 0==a.type&&(globalData.isInDoorLocated=!1,globalData.gpsLoaction_lon=parseFloat(a.x),globalData.gpsLocation_lat=parseFloat(a.y),outDoorMapUtil.markerOutDoorLocate(globalData.gpsLoaction_lon,globalData.gpsLocation_lat))},window.sendMapRes=function(t){globalData.appArr=JSON.parse(t).maps},window.doJumpApp=function(t){control.jumpMap(t)};var map,isAllLoaded=!1,clickType=0,clickMarker=null,searchMarkers=[],needMapClick=!1,isPoiClick=!1,loadedGroups=[];window.onload=function(){createFMap()};var pageindex=0,isStartInput=2,fmEvents_=fmEvents.create();$(function(){form.onsubmit=function(){return!1},$(".header-wrap,.category-wrap,.category-cont").on("touchmove",function(t){t.preventDefault()}),resolveScroll(),fmEvents_.bindMapClickEvent(),$("#backBtn").on("click",function(){$(".category-pop").hide(),$(".clearBtn").hide(),$(this).find("i").removeClass("icon-fanhui").addClass("icon-search"),$("#searchTxt").val(""),pageindex=0}),getPoiType(),$("#searchTxt").on("input",function(){showSearchList(searchModelByKeyword(this.value))}),$("#clearBtn").on("click",function(){var t=$(this).prev().val();if(null==t||""==t)return $(".category-pop").hide(),$(".clearBtn").hide(),$(this).siblings("#backBtn").find("i").removeClass("icon-fanhui").addClass("icon-search"),$("#searchTxt").val(""),void(pageindex=0);$(this).prev().val(""),hideSearchList()}),$("#goToRoute").click(function(){hideClickModelInfo(),clickType=1,showRoute()}),$("#startNavi").click(function(){return getRouteDistance()<=0?void commonAlert(errorMsg.NO_ROUTE):isMyLocation($("#route-panel input[name='endTxt']").val())?void commonAlert(errorMsg.TOO_CLOSE):globalData.cur_Point?(setMyLocToStartPnt(),getRouteDistance()<=0?void commonAlert(errorMsg.NO_ROUTE):(hideRoute(),switchVoiceIcon(!0),globalData.preTouchedTime=0,globalData.isTouched=!1,isNaving||(globalData.currentLevel=getMapScaleLevel(),globalData.currentMapRotate=getMapRotateAngle()),globalData.isRecalcRoute=!1,globalData.NaviConstraintTime=(new Date).getTime(),void showNaviPage())):void commonAlert(errorMsg.NO_LOCATION)}),$("#locationBtn").click(function(){globalData.cur_Point?(setLocIconToBlue(),globalData.preTouchedTime=0,showMyLocation(),moveToCenter(globalData.cur_Point)):0==globalData.isInDoorLocated&&resetInDoorLocation()}),$(".loc-btn-wrap").click(function(){var t=$("#route-panel input[name='startTxt']").val(),a=getPointByName("#route-panel input[name='startTxt']"),e=$("#route-panel input[name='endTxt']").val(),o=getPointByName("#route-panel input[name='endTxt']");$("#route-panel input[name='startTxt']").val(e),setInputDataAttr("#route-panel input[name='startTxt']",o),$("#route-panel input[name='endTxt']").val(t),setInputDataAttr("#route-panel input[name='endTxt']",a),1==isStartInput?isStartInput=2:2==isStartInput&&(isStartInput=1),addRouteLine(o,o.groupID,!0,a,a.groupID,!1),showRouteTip(o,a)}),$("#mapSwitchBtn").on("click",function(t){var a=$(this).children();a.hasClass("change-active")?(a.removeClass("change-active"),switchMapMode(0)):(a.addClass("change-active"),switchMapMode(1))}),showOutDoorMap(),$("#voiceStatus").click(function(){var t=$(this).children();t.hasClass("voice-active")?(t.removeClass("voice-active"),start()):(t.addClass("voice-active"),stop())}),$("#clearAllStatus").click(function(){isStartInput=2,clearAll(),hideRoute(),hideClickModelInfo()}),$(".category-cont.btns .btn-myloc").click(function(){if(!globalData.cur_Point)return void commonAlert(errorMsg.NO_LOCATION);var t=isHasMyLocation();return 1==t&&2==isStartInput?void commonAlert(errorMsg.START_END_SAME):1==isStartInput&&2==t?void commonAlert(errorMsg.START_END_SAME):void setMyLoc()}),$(".category-cont.btns .btn-maploc").click(function(){setMapClickLoc()}),
$(".navi-stop-img").click(function(){showConfirmStopNavi()})});